<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="bs5.css" rel="stylesheet">
<link href="bootstrap-icons-1.13.1/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="styles.css" rel="stylesheet">

</head>
<body>

<button class="register-theme-btn" onclick="toggleTheme()" title="تغییر تم">
  <i class="bi bi-moon-stars" id="themeIcon"></i>
</button>

<div class="register-page">
  <div class="register-card">

    <!-- Logo -->
    <div class="register-logo">
      <div class="logo-icon"><i class="bi bi-book-half"></i></div>
      <h1>سامانه جامع محبوب</h1>
      <p>ورود یا ثبت‌نام با شماره موبایل</p>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step-dot active" id="step1Dot">۱</div>
      <div class="step-line" id="stepLine"></div>
      <div class="step-dot" id="step2Dot">۲</div>
    </div>

    <!-- ═══ Step 1: Phone Number ═══ -->
    <div id="step1">
      <div class="phone-input-wrap">
        <input type="tel" class="phone-input" id="phoneInput"
               placeholder="شماره موبایل خود را وارد کنید" maxlength="11"
               autocomplete="tel">
      </div>
      <button class="register-btn" id="sendCodeBtn" onclick="sendCode()" disabled>
        <div class="spinner"></div>
        <span><i class="bi bi-send-fill"></i> ارسال کد تأیید</span>
      </button>
      <div class="register-terms">
        با ورود و ثبت‌نام، <a href="terms.html">قوانین استفاده</a> و
        <a href="privacy.html">حریم خصوصی</a> را می‌پذیرم.
      </div>
    </div>

    <!-- ═══ Step 2: OTP Verification ═══ -->
    <div id="step2" style="display:none">
      <div class="otp-info">
        <div class="otp-phone-display">
          کد تأیید ارسال شد به <strong id="displayPhone"></strong>
        </div>
        <div class="otp-edit-phone" onclick="goBackToPhone()">
          <i class="bi bi-pencil"></i> ویرایش شماره
        </div>
      </div>

      <div class="otp-wrap">
        <input type="tel" class="otp-input" maxlength="1" data-idx="0" oninput="otpInput(this)" onkeydown="otpKeydown(event,this)" autofocus>
        <input type="tel" class="otp-input" maxlength="1" data-idx="1" oninput="otpInput(this)" onkeydown="otpKeydown(event,this)">
        <input type="tel" class="otp-input" maxlength="1" data-idx="2" oninput="otpInput(this)" onkeydown="otpKeydown(event,this)">
        <input type="tel" class="otp-input" maxlength="1" data-idx="3" oninput="otpInput(this)" onkeydown="otpKeydown(event,this)">
        <input type="tel" class="otp-input" maxlength="1" data-idx="4" oninput="otpInput(this)" onkeydown="otpKeydown(event,this)">
      </div>

      <div class="otp-info">
        <div id="timerWrap">
          <span class="otp-resend">ارسال مجدد تا </span>
          <span class="otp-timer" id="timerDisplay">02:00</span>
        </div>
        <div id="resendWrap" style="display:none">
          <span class="otp-resend active" onclick="resendCode()">
            <i class="bi bi-arrow-clockwise"></i> ارسال مجدد کد
          </span>
        </div>
      </div>

      <button class="register-btn" id="verifyBtn" onclick="verifyCode()" disabled>
        <div class="spinner"></div>
        <span><i class="bi bi-shield-check"></i> تأیید و ورود</span>
      </button>
    </div>

    <!-- ═══ Step 3: Success ═══ -->
    <div class="register-success" id="step3">
      <div class="success-icon"><i class="bi bi-check-lg"></i></div>
      <div class="success-title">خوش آمدید!</div>
      <div class="success-desc">ثبت‌نام شما با موفقیت انجام شد.<br>اکنون می‌توانید از تمامی امکانات محبوب استفاده کنید.</div>
      <a href="index.html" class="success-home-btn">
        <i class="bi bi-house-fill"></i>
        ورود به سامانه
      </a>
    </div>

    <div class="register-back" id="backLink">
      <a href="index.html"><i class="bi bi-arrow-right"></i> بازگشت به صفحه اصلی</a>
    </div>

  </div>
</div>

<script>
// ═══ Theme ═══
function toggleTheme() {
  const b = document.body, i = document.getElementById('themeIcon');
  if (b.getAttribute('data-theme') === 'dark') {
    b.removeAttribute('data-theme'); i.className = 'bi bi-moon-stars';
    localStorage.setItem('mahboob-theme','light');
  } else {
    b.setAttribute('data-theme','dark'); i.className = 'bi bi-sun-fill';
    localStorage.setItem('mahboob-theme','dark');
  }
}
(function(){
  const s = localStorage.getItem('mahboob-theme');
  if(s==='dark'){document.body.setAttribute('data-theme','dark');document.getElementById('themeIcon').className='bi bi-sun-fill'}
})();

// ═══ Digit Conversion ═══
const toPersian = s => String(s).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
const toEnglish = s => String(s).replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));

// ═══ Phone Validation ═══
const phoneInput = document.getElementById('phoneInput');
const sendBtn = document.getElementById('sendCodeBtn');
let rawPhone = ''; // store English digits

phoneInput.addEventListener('input', () => {
  // Extract only digits (both Persian & English)
  let eng = toEnglish(phoneInput.value).replace(/[^0-9]/g, '').slice(0, 11);
  rawPhone = eng;
  // Display as Persian
  phoneInput.value = toPersian(eng);
  // Validate: must be 09xxxxxxxxx (11 digits)
  sendBtn.disabled = !(eng.length === 11 && /^09\d{9}$/.test(eng));
});
phoneInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !sendBtn.disabled) sendCode();
});

// ═══ Send Code ═══
function sendCode() {
  if (rawPhone.length < 11) return;

  sendBtn.classList.add('loading');
  sendBtn.disabled = true;

  // Simulate API call
  setTimeout(() => {
    sendBtn.classList.remove('loading');

    // Move to step 2
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    document.getElementById('step1Dot').classList.remove('active');
    document.getElementById('step1Dot').classList.add('done');
    document.getElementById('step1Dot').innerHTML = '<i class="bi bi-check"></i>';
    document.getElementById('stepLine').classList.add('active');
    document.getElementById('step2Dot').classList.add('active');
    document.getElementById('displayPhone').textContent = toPersian(rawPhone);

    // Focus first OTP input
    document.querySelector('.otp-input[data-idx="0"]').focus();

    // Start timer
    startTimer(120);
  }, 1500);
}

// ═══ OTP Input Logic ═══
function otpInput(el) {
  let val = toEnglish(el.value).replace(/[^0-9]/g, '');
  el.value = val ? toPersian(val) : '';
  if (el.value) {
    el.classList.add('filled');
    const idx = parseInt(el.dataset.idx);
    if (idx < 4) {
      document.querySelector(`.otp-input[data-idx="${idx+1}"]`).focus();
    }
  } else {
    el.classList.remove('filled');
  }
  checkOTPComplete();
}

function otpKeydown(e, el) {
  const idx = parseInt(el.dataset.idx);
  if (e.key === 'Backspace' && !el.value && idx > 0) {
    const prev = document.querySelector(`.otp-input[data-idx="${idx-1}"]`);
    prev.value = '';
    prev.classList.remove('filled');
    prev.focus();
  }
  if (e.key === 'Enter') verifyCode();
}

function checkOTPComplete() {
  const inputs = document.querySelectorAll('.otp-input');
  let code = '';
  inputs.forEach(i => code += i.value);
  document.getElementById('verifyBtn').disabled = code.length < 5;
}

function getOTPCode() {
  let code = '';
  document.querySelectorAll('.otp-input').forEach(i => code += toEnglish(i.value));
  return code.replace(/[^0-9]/g, '');
}

// ═══ Timer ═══
let timerInterval;
function startTimer(seconds) {
  clearInterval(timerInterval);
  document.getElementById('timerWrap').style.display = '';
  document.getElementById('resendWrap').style.display = 'none';

  let remaining = seconds;
  function update() {
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    const pn = n => String(n).padStart(2, '0');
    document.getElementById('timerDisplay').textContent = toPersian(`${pn(m)}:${pn(s)}`);

    if (remaining <= 0) {
      clearInterval(timerInterval);
      document.getElementById('timerWrap').style.display = 'none';
      document.getElementById('resendWrap').style.display = '';
    }
    remaining--;
  }
  update();
  timerInterval = setInterval(update, 1000);
}

function resendCode() {
  // Clear OTP
  document.querySelectorAll('.otp-input').forEach(i => {
    i.value = '';
    i.classList.remove('filled', 'error');
  });
  document.querySelector('.otp-input[data-idx="0"]').focus();
  document.getElementById('verifyBtn').disabled = true;

  startTimer(120);
}

// ═══ Verify Code ═══
function verifyCode() {
  const code = getOTPCode();
  if (code.length < 5) return;

  const btn = document.getElementById('verifyBtn');
  btn.classList.add('loading');
  btn.disabled = true;

  // Simulate verification
  setTimeout(() => {
    btn.classList.remove('loading');

    // For demo: any 5 digits work. Show error for "00000"
    if (code === '00000') {
      document.querySelectorAll('.otp-input').forEach(i => {
        i.classList.add('error');
        i.value = '';
        i.classList.remove('filled');
      });
      btn.disabled = true;
      setTimeout(() => {
        document.querySelectorAll('.otp-input').forEach(i => i.classList.remove('error'));
        document.querySelector('.otp-input[data-idx="0"]').focus();
      }, 600);
      return;
    }

    // Success!
    clearInterval(timerInterval);
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step2Dot').classList.remove('active');
    document.getElementById('step2Dot').classList.add('done');
    document.getElementById('step2Dot').innerHTML = '<i class="bi bi-check"></i>';
    document.querySelector('.step-indicator').style.display = 'none';
    document.getElementById('backLink').style.display = 'none';

    const success = document.getElementById('step3');
    success.classList.add('show');
  }, 1800);
}

// ═══ Go Back to Phone ═══
function goBackToPhone() {
  clearInterval(timerInterval);
  document.getElementById('step2').style.display = 'none';
  document.getElementById('step1').style.display = 'block';
  document.getElementById('step1Dot').classList.add('active');
  document.getElementById('step1Dot').classList.remove('done');
  document.getElementById('step1Dot').innerHTML = '۱';
  document.getElementById('stepLine').classList.remove('active');
  document.getElementById('step2Dot').classList.remove('active');

  // Clear OTP
  document.querySelectorAll('.otp-input').forEach(i => {
    i.value = '';
    i.classList.remove('filled', 'error');
  });

  sendBtn.disabled = false;
  phoneInput.focus();
}

// Handle paste for OTP
document.addEventListener('paste', (e) => {
  if (!document.querySelector('.otp-input:focus')) return;
  e.preventDefault();
  const pasted = (e.clipboardData || window.clipboardData).getData('text').replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/\D/g, '').slice(0, 5);
  if (pasted.length === 5) {
    document.querySelectorAll('.otp-input').forEach((input, i) => {
      input.value = toPersian(pasted[i]);
      input.classList.add('filled');
    });
    document.querySelector('.otp-input[data-idx="4"]').focus();
    checkOTPComplete();
  }
});
</script>
</body>
</html>